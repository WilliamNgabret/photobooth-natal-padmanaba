// GIF.js Worker
// This is the worker script for gif.js library
// Source: https://github.com/jnordberg/gif.js

(function(b){function a(b,d){if({}.hasOwnProperty.call(a.cache,b))return a.cache[b];var e=a.resolve(b);if(!e)throw new Error("Failed to resolve module "+b);var c={id:b,require:a,filename:b,exports:{},loaded:!1,parent:d,children:[]};d&&d.children.push(c);var f=b.slice(0,b.lastIndexOf("/")+1);return a.cache[b]=c.exports,e.call(c.exports,c,c.exports,f,b),c.loaded=!0,a.cache[b]=c.exports}a.modules={},a.cache={},a.resolve=function(b){return{}.hasOwnProperty.call(a.modules,b)?a.modules[b]:void 0},a.define=function(b,c){a.modules[b]=c},a.define("/gif.worker.coffee",function(b,d,e,c){var f,g;f=a("./GIFEncoder.js",b),g=function(a){var b,c,d,e,g,h;return b=new f(a.width,a.height),a.index===0?b.writeHeader():b.firstFrame=!1,b.setTransparent(a.transparent),b.setRepeat(a.repeat),b.setDelay(a.delay),b.setQuality(a.quality),b.setDither(a.dither),b.setGlobalPalette(a.globalPalette),b.addFrame(a.data),a.last&&b.finish(),h=b.stream(),e=h.pages,g=[],c=0,d=e.length;c<d;++c)f=e[c],g.push(f);return{data:g,cursor:b.stream().cursor,pageSize:h.constructor.pageSize}},"undefined"!=typeof self&&self!==null?self.onmessage=function(a){return self.postMessage(g(a.data))}:b.exports=g}),a.define("/GIFEncoder.js",function(b,d,e,c){function f(){this.page=-1,this.pages=[],this.newPage()}f.pageSize=4096,f.charMap={};for(var a=0;a<256;a++)f.charMap[a]=String.fromCharCode(a);f.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(f.pageSize),this.cursor=0},f.prototype.getData=function(){var a="";for(var b=0;b<this.pages.length;b++)for(var c=0;c<f.pageSize;c++)a+=f.charMap[this.pages[b][c]];return a},f.prototype.toBuffer=function(){var a=[],b=0;for(var c=0;c<this.pages.length;c++){var d=this.page===c?this.cursor:f.pageSize;for(var e=0;e<d;e++)a.push(this.pages[c][e])}return a},f.prototype.writeByte=function(a){this.cursor>=f.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=a},f.prototype.writeUTFBytes=function(a){for(var b=a.length,c=0;c<b;c++)this.writeByte(a.charCodeAt(c))},f.prototype.writeBytes=function(a,b,c){for(var d=c||a.length,e=b||0;e<d;e++)this.writeByte(a[e])};function g(){this.width=null,this.height=null,this.transparent=null,this.transIndex=0,this.repeat=-1,this.delay=0,this.image=null,this.pixels=null,this.indexedPixels=null,this.colorDepth=null,this.colorTab=null,this.neuQuant=null,this.usedEntry=[],this.palSize=7,this.dispose=-1,this.firstFrame=!0,this.sample=10,this.dither=!1,this.globalPalette=!1,this.out=new f}g.prototype.setDelay=function(a){this.delay=Math.round(a/10)},g.prototype.setFrameRate=function(a){this.delay=Math.round(100/a)},g.prototype.setDispose=function(a){a>=0&&(this.dispose=a)},g.prototype.setRepeat=function(a){this.repeat=a},g.prototype.setTransparent=function(a){this.transparent=a},g.prototype.addFrame=function(a){this.image=a,this.colorTab=this.globalPalette&&this.globalPalette.slice?this.globalPalette:null,this.getImagePixels(),this.analyzePixels(),this.globalPalette===!0&&(this.globalPalette=this.colorTab),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),this.firstFrame||this.globalPalette||this.writePalette(),this.writePixels(),this.firstFrame=!1},g.prototype.finish=function(){this.out.writeByte(59)},g.prototype.setQuality=function(a){a<1&&(a=1),this.sample=a},g.prototype.setDither=function(a){a===!0&&(a="FloydSteinberg"),this.dither=a},g.prototype.setGlobalPalette=function(a){this.globalPalette=a},g.prototype.getGlobalPalette=function(){return this.globalPalette&&this.globalPalette.slice&&this.globalPalette.slice(0)||this.globalPalette},g.prototype.writeHeader=function(){this.out.writeUTFBytes("GIF89a")},g.prototype.analyzePixels=function(){this.colorTab||(this.neuQuant=new h(this.pixels,this.sample),this.neuQuant.buildColormap(),this.colorTab=this.neuQuant.getColormap()),this.dither?this.ditherPixels(this.dither.replace("-serpentine",""),this.dither.match(/-serpentine/)!==null):this.indexPixels(),this.pixels=null,this.colorDepth=8,this.palSize=7,this.transparent!==null&&(this.transIndex=this.findClosest(this.transparent,!0))},g.prototype.indexPixels=function(a){var b=this.pixels.length/3;this.indexedPixels=new Uint8Array(b);var c=0;for(var d=0;d<b;d++){var e=this.findClosestRGB(this.pixels[c++]&255,this.pixels[c++]&255,this.pixels[c++]&255);this.usedEntry[e]=!0,this.indexedPixels[d]=e}},g.prototype.ditherPixels=function(a,b){var c={FalseFloydSteinberg:[[3/8,1,0],[3/8,0,1],[2/8,1,1]],FloydSteinberg:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],Stucki:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],Atkinson:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]]},d=c[a];if(!d)throw new Error("Unknown dithering kernel: "+a);var e,f=0,g=this.height,h=this.width,i=this.pixels,j=b?-1:1;this.indexedPixels=new Uint8Array(this.pixels.length/3);for(var k=0;k<g;k++){b&&(j*=-1);for(var l=j===1?0:h-1,m=j===1?h:0;l!==m;l+=j){e=k*h+l;var n=e*3,o=i[n],p=i[n+1],q=i[n+2];e=this.findClosestRGB(o,p,q),this.usedEntry[e]=!0,this.indexedPixels[f++]=e;var r=this.colorTab[e*3]-o,s=this.colorTab[e*3+1]-p,t=this.colorTab[e*3+2]-q;for(var u=j===1?0:d.length-1,v=j===1?d.length:0;u!==v;u+=j){var w=d[u][1],x=d[u][2];if(w+l>=0&&w+l<h&&x+k>=0&&x+k<g){var y=d[u][0];e=(k+x)*h+l+w;var z=e*3;i[z]=Math.max(0,Math.min(255,i[z]+r*y)),i[z+1]=Math.max(0,Math.min(255,i[z+1]+s*y)),i[z+2]=Math.max(0,Math.min(255,i[z+2]+t*y))}}}}},g.prototype.findClosest=function(a,b){return this.findClosestRGB((a&16711680)>>16,(a&65280)>>8,a&255,b)},g.prototype.findClosestRGB=function(a,b,c,d){if(this.colorTab===null)return-1;if(this.neuQuant&&!d)return this.neuQuant.lookupRGB(a,b,c);var e=0,f=16777216,g=this.colorTab.length;for(var h=0;h<g;h+=3){var i=a-(this.colorTab[h]&255),j=b-(this.colorTab[h+1]&255),k=c-(this.colorTab[h+2]&255),l=i*i+j*j+k*k;if((!d||this.usedEntry[h/3])&&l<f)f=l,e=h/3}return e},g.prototype.getImagePixels=function(){var a=this.width,b=this.height;this.pixels=new Uint8Array(a*b*3);var c=this.image,d=0;for(var e=0;e<b;e++)for(var f=0;f<a;f++){var g=e*a*4+f*4;this.pixels[d++]=c[g],this.pixels[d++]=c[g+1],this.pixels[d++]=c[g+2]}},g.prototype.writeLSD=function(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)},g.prototype.writeNetscapeExt=function(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.out.writeUTFBytes("NETSCAPE2.0"),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)},g.prototype.writePalette=function(){this.out.writeBytes(this.colorTab);var a=768-this.colorTab.length;for(var b=0;b<a;b++)this.out.writeByte(0)},g.prototype.writeShort=function(a){this.out.writeByte(a&255),this.out.writeByte(a>>8&255)},g.prototype.writePixels=function(){var a=new i(this.width,this.height,this.indexedPixels,this.colorDepth);a.encode(this.out)},g.prototype.writeGraphicCtrlExt=function(){this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4);var a,b;this.transparent===null?(a=0,b=0):(a=1,b=2),this.dispose>=0&&(b=this.dispose&7),b<<=2,this.out.writeByte(0|b|0|a),this.writeShort(this.delay),this.out.writeByte(this.transIndex),this.out.writeByte(0)},g.prototype.writeImageDesc=function(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame||this.globalPalette?this.out.writeByte(0):this.out.writeByte(128|this.palSize)},g.prototype.stream=function(){return this.out};function h(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P;function Q(){g=[],n=new Int32Array(256),o=new Int32Array(C),p=new Int32Array(C),q=new Int32Array(C>>3);var a,b;for(a=0;a<C;a++)b=(a<<D+8)/C,g[a]=[b,b,b,0],o[a]=E/C,p[a]=0}function R(){c=a,m=0,e=c.length,d=1,f=0;if(e<H*3)throw new Error("Image is too small")}function S(){var a,b,c,d,e,f,g=c.length/3,h=~~(g/l),i=0,j=0;for(;j<l;){a=c[i++],b=c[i++],d=c[i++],f=T(a,b,d),U(f,a,b,d),e=V(f),W(e,a,b,d),e>f?s++:e<f&&t++,j++}}function T(a,b,c){var d,e,f,h,i,j,k,l,m;l=2147483647,m=-1,d=u,e=d-1;while(d<v){k=g[d],f=k[0]-a,f<0&&(f=-f),h=k[1]-b,h<0&&(h=-h),f+=h,h=k[2]-c,h<0&&(h=-h),f+=h,f<l&&(l=f,m=d),j=n[d++],j+=f,k[3]=j,j<w&&(u=d,w=j);if(e>=y){k=g[e],f=k[0]-a,f<0&&(f=-f),h=k[1]-b,h<0&&(h=-h),f+=h,h=k[2]-c,h<0&&(h=-h),f+=h,j=n[e],j+=f,k[3]=j,j<x&&(v=e+1,x=j)}e--}return m}function U(a,b,c,d){var e=g[a];e[0]-=r*(e[0]-b)/I,e[1]-=r*(e[1]-c)/I,e[2]-=r*(e[2]-d)/I}function V(a){var b,c,d,e,f,h,i,j,k;j=2147483647,k=-1,b=a-z,b<y&&(b=y),c=a+z,c>A&&(c=A);for(d=a+1,e=a-1;d<c||e>b;){if(d<c){i=g[d],h=i[0]-f,h<0&&(h=-h),f=i[1],f<0&&(f=-f),h+=f,f=i[2],f<0&&(f=-f),h+=f,h<j&&(j=h,k=d),d++}if(e>b){i=g[e],h=i[0]-f,h<0&&(h=-h),f=i[1],f<0&&(f=-f),h+=f,f=i[2],f<0&&(f=-f),h+=f,h<j&&(j=h,k=e),e--}}return k}function W(a,b,c,d){var e,f,h,i,k,l,m,n,s=a-z,t=a+z;s<y&&(s=y),t>A&&(t=A),e=a+1,f=a-1,h=1;while(e<t||f>s)i=o[h++],e<t&&(l=g[e++],m=l[0],n=i*(m-b)>>J,l[0]-=n,m=l[1],n=i*(m-c)>>J,l[1]-=n,m=l[2],n=i*(m-d)>>J,l[2]-=n),f>s&&(l=g[f--],m=l[0],n=i*(m-b)>>J,l[0]-=n,m=l[1],n=i*(m-c)>>J,l[1]-=n,m=l[2],n=i*(m-d)>>J,l[2]-=n)}function X(){var a,c,d,e,f,h,i,k,l,m;for(k=[],a=0;a<C;a++){i=g[a],l=a,h=i[1],c=a+1;while(c<C)j=g[c],j[1]<h&&(l=c,h=j[1]),c++;j=g[l],a!=l&&(m=j[0],j[0]=i[0],i[0]=m,m=j[1],j[1]=i[1],i[1]=m,m=j[2],j[2]=i[2],i[2]=m,m=j[3],j[3]=i[3],i[3]=m),h<<=D,h>255&&(h=255),k[a]=255-h}return k}function Y(){var a,b,c,d,e,f;for(a=0;a<C;a++)q[g[a][0]+g[a][1]+g[a][2]>>L]=a;return q}function Z(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,r,s;for(k=2147483647,l=-1,d=q[a+b+c>>L],e=d-1;d<C||e>=y;){if(d<C){h=p[d],h<k&&(i=g[d],j=i[0]-a,j<0&&(j=-j),j<k&&(n=i[1]-b,n<0&&(n=-n),j+=n,j<k&&(o=i[2]-c,o<0&&(o=-o),j+=o,j<k&&(k=j,l=d)))),d++}if(e>=y){h=p[e],h<k&&(i=g[e],j=i[0]-a,j<0&&(j=-j),j<k&&(n=i[1]-b,n<0&&(n=-b),j+=n,j<k&&(o=i[2]-c,o<0&&(o=-o),j+=o,j<k&&(k=j,l=e)))),e--}}return l}j=a,k=b,C=256,D=4,E=100,F=16,G=1<<F,H=3*256,I=1024,J=10,K=10,L=D+3,M=1<<L,y=C>>3,z=C>>2,A=C-1,B=C>>1;var h=this;h.buildColormap=function(){R(),Q(),S(),X()},h.getColormap=function(){var a,b=[],c;for(a=0;a<C;a++)b[a*3]=g[a][0],b[a*3+1]=g[a][1],b[a*3+2]=g[a][2];return b},h.lookupRGB=function(a,b,c){var d,e,f,h,i,j;for(i=1e3,j=-1,d=q[a+b+c>>L],e=d-1;d<C||e>=y;){if(d<C){h=g[d],f=h[0]-a,f<0&&(f=-f),f<i&&(f+=(h=g[d])[1]-b,f<0&&(f=-f),f<i&&(f+=h[2]-c,f<0&&(f=-f),f<i&&(i=f,j=d))),d++}if(e>=y){h=g[e],f=h[0]-a,f<0&&(f=-f),f<i&&(f+=h[1]-b,f<0&&(f=-f),f<i&&(f+=h[2]-c,f<0&&(f=-f),f<i&&(i=f,j=e))),e--}}return j}}function i(a,b,c,d){function v(a,b){w[y++]=a,y>=254&&x(b)}function x(a){y>0&&(a.writeByte(y),a.writeBytes(w,0,y),y=0)}function z(a){A(t+(1<<a)-1)}function A(a){r=(r<<s)+a;for(s+=a;s>=8;)w[y++]=r&255,y>=254&&x(q),r>>=8,s-=8;if(o>=j&&p<n){o=1<<++p,++p==n&&(p=n-1),j=o-1}}function B(){A(i),s>0&&(A(0),x(q),q.writeByte(0))}var e,f,g,h,i,j,k,l,m,o,p,q,r,s,t,u,v,w,x,y;var a=this;a.encode=function(a){q=a,y=0,w=new Uint8Array(256),r=0,s=0,o=0,p=f,j=(1<<p)-1,i=j+1,t=i+1,m=-1,e=Math.ceil(Math.log(g+1)/Math.log(2)),h=1+(1<<e),k=new Int32Array(h),l=new Int32Array(h),k.fill(-1),z(f);for(var b=0;b<g;b++){var c=u[b];if(m!==-1){var d=c<<e|m;if(k[d]!==-1){m=l[d];continue}k[d]=t<n?t++:i,l[d]=c}else m=c}m!==-1&&A(m),B(),q.writeByte(0)};var C=arguments;e=C[0],f=C[1],g=C[2]*C[3],u=C[4],n=1<<C[5]}b.exports=g}),a("/gif.worker.coffee")}).call(this);
